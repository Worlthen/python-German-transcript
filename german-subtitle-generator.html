<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­—å¹•ç”Ÿæˆå™¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .main-content {
            padding: 40px;
        }

        .upload-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            border: 2px dashed #dee2e6;
            text-align: center;
            transition: all 0.3s ease;
        }

        .upload-section:hover {
            border-color: #4facfe;
            background: #f0f8ff;
        }

        .upload-section.dragover {
            border-color: #00f2fe;
            background: #e6f3ff;
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 4rem;
            color: #6c757d;
            margin-bottom: 20px;
        }

        .upload-text {
            font-size: 1.2rem;
            color: #495057;
            margin-bottom: 20px;
        }

        .file-input {
            display: none;
        }

        .upload-btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(79, 172, 254, 0.4);
        }

        .upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(79, 172, 254, 0.6);
        }

        .settings-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .setting-group {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
        }

        .setting-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #495057;
        }

        .setting-group select,
        .setting-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .setting-group select:focus,
        .setting-group input:focus {
            outline: none;
            border-color: #4facfe;
        }

        .process-btn {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 25px;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(17, 153, 142, 0.4);
            width: 100%;
            margin-top: 20px;
        }

        .process-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(17, 153, 142, 0.6);
        }

        .process-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .progress-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 10px;
        }

        .progress-text {
            text-align: center;
            font-weight: 600;
            color: #495057;
        }

        .result-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            display: none;
        }

        .video-preview {
            width: 100%;
            max-width: 600px;
            margin: 0 auto 30px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .subtitle-editor {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .subtitle-item {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #4facfe;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .subtitle-time {
            font-size: 0.9rem;
            color: #6c757d;
            margin-bottom: 5px;
        }

        .subtitle-text {
            width: 100%;
            border: none;
            background: transparent;
            font-size: 1rem;
            resize: vertical;
            min-height: 40px;
        }

        .subtitle-text:focus {
            outline: none;
        }

        .download-section {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        .download-btn {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 20px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .download-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(250, 112, 154, 0.4);
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            border: 1px solid #f5c6cb;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            border: 1px solid #c3e6cb;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .main-content {
                padding: 20px;
            }
            
            .settings-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¬ å­—å¹•ç”Ÿæˆå™¨</h1>
            <p>åŸºäºWhisperçš„æ™ºèƒ½å­—å¹•ç”Ÿæˆå·¥å…·</p>
            <div style="margin-top: 15px; font-size: 0.9rem; opacity: 0.8;">
                æ”¯æŒå¤šç§è§†é¢‘æ ¼å¼ | æœ¬åœ°åŒ–å¤„ç† | å¯ç¼–è¾‘å­—å¹•
            </div>
        </div>

        <div class="main-content">
            <!-- æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ -->
            <div class="upload-section" id="uploadSection">
                <div class="upload-icon">ğŸ“</div>
                <div class="upload-text">æ‹–æ‹½è§†é¢‘æ–‡ä»¶åˆ°æ­¤å¤„æˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</div>
                <div style="font-size: 0.9rem; color: #6c757d; margin-top: 10px;">
                    æ”¯æŒæ ¼å¼: MP4, WebM, AVI, MOV, MKV | æœ€å¤§500MB
                </div>
                <input type="file" id="fileInput" class="file-input" accept="video/*">
                <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                    é€‰æ‹©è§†é¢‘æ–‡ä»¶
                </button>
                <div id="fileName" style="margin-top: 15px; font-weight: 600; color: #495057;"></div>
            </div>

            <!-- è®¾ç½®åŒºåŸŸ -->
            <div class="settings-section">
                <h3 style="margin-bottom: 20px; color: #495057;">âš™ï¸ ç”Ÿæˆè®¾ç½®</h3>
                <div class="settings-grid">
                    <div class="setting-group">
                        <label for="sourceLanguage">æºè¯­è¨€</label>
                        <select id="sourceLanguage">
                            <option value="auto">è‡ªåŠ¨æ£€æµ‹</option>
                            <option value="zh">ä¸­æ–‡</option>
                            <option value="en">è‹±è¯­</option>
                            <option value="ja">æ—¥è¯­</option>
                            <option value="ko">éŸ©è¯­</option>
                            <option value="fr">æ³•è¯­</option>
                            <option value="es">è¥¿ç­ç‰™è¯­</option>
                        </select>
                    </div>

                    <div class="setting-group">
                        <label for="whisperUrl">WhisperæœåŠ¡åœ°å€</label>
                        <input type="text" id="whisperUrl" value="http://localhost:9000" placeholder="http://localhost:9000">
                    </div>
                    <div class="setting-group">
                        <label for="maxDuration">æœ€å¤§å¤„ç†æ—¶é•¿(ç§’)</label>
                        <input type="number" id="maxDuration" value="300" min="30" max="3600" placeholder="500">
                    </div>
                </div>
                <button class="process-btn" id="processBtn" onclick="processVideo()" disabled>
                    ğŸš€ å¼€å§‹ç”Ÿæˆå­—å¹•
                </button>
                <div style="margin-top: 15px; padding: 15px; background: #e3f2fd; border-radius: 8px; font-size: 0.9rem; color: #1565c0;">
                    <strong>ğŸ’¡ ä½¿ç”¨æç¤ºï¼š</strong><br>
                    1. ç¡®ä¿WhisperæœåŠ¡è¿è¡Œåœ¨ http://localhost:9000<br>
                    2. å»ºè®®ä½¿ç”¨æ¸…æ™°éŸ³è´¨çš„è§†é¢‘æ–‡ä»¶ä»¥è·å¾—æ›´å¥½æ•ˆæœ
                </div>
            </div>

            <!-- è¿›åº¦åŒºåŸŸ -->
            <div class="progress-section" id="progressSection">
                <h3 style="margin-bottom: 20px; color: #495057;">ğŸ”„ å¤„ç†è¿›åº¦</h3>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-text" id="progressText">å‡†å¤‡ä¸­...</div>
            </div>

            <!-- ç»“æœåŒºåŸŸ -->
            <div class="result-section" id="resultSection">
                <h3 style="margin-bottom: 20px; color: #495057;">âœ… ç”Ÿæˆç»“æœ</h3>
                <div class="video-preview">
                    <video id="videoPreview" controls style="width: 100%;"></video>
                </div>
                
                <div class="subtitle-editor" id="subtitleEditor">
                    <h4 style="margin-bottom: 15px; color: #495057;">å­—å¹•ç¼–è¾‘å™¨</h4>
                    <div id="subtitleList"></div>
                </div>

                <div class="download-section">
                    <button class="download-btn" onclick="downloadSRT()">
                        ğŸ“„ ä¸‹è½½SRTæ–‡ä»¶
                    </button>
                    <button class="download-btn" onclick="downloadVTT()">
                        ğŸ“ ä¸‹è½½VTTæ–‡ä»¶
                    </button>
                    <button class="download-btn" onclick="downloadJSON()">
                        ğŸ”§ ä¸‹è½½JSONæ–‡ä»¶
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let selectedFile = null;
        let subtitles = [];
        let audioContext = null;

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            setupDragAndDrop();
            setupFileInput();
        });

        // è®¾ç½®æ‹–æ‹½ä¸Šä¼ 
        function setupDragAndDrop() {
            const uploadSection = document.getElementById('uploadSection');
            
            uploadSection.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadSection.classList.add('dragover');
            });

            uploadSection.addEventListener('dragleave', function(e) {
                e.preventDefault();
                uploadSection.classList.remove('dragover');
            });

            uploadSection.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadSection.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileSelect(files[0]);
                }
            });
        }

        // è®¾ç½®æ–‡ä»¶è¾“å…¥
        function setupFileInput() {
            const fileInput = document.getElementById('fileInput');
            fileInput.addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    handleFileSelect(e.target.files[0]);
                }
            });
        }

        // å¤„ç†æ–‡ä»¶é€‰æ‹© - æ·»åŠ æ–‡ä»¶éªŒè¯å’Œå¤§å°æ£€æŸ¥
        function handleFileSelect(file) {
            if (!file.type.startsWith('video/')) {
                showError('è¯·é€‰æ‹©æœ‰æ•ˆçš„è§†é¢‘æ–‡ä»¶');
                return;
            }
            
            // æ£€æŸ¥æ–‡ä»¶å¤§å° (é™åˆ¶ä¸º500MB)
            const maxSize = 500 * 1024 * 1024; // 500MB
            if (file.size > maxSize) {
                showError('æ–‡ä»¶è¿‡å¤§ï¼Œè¯·é€‰æ‹©å°äº500MBçš„è§†é¢‘æ–‡ä»¶');
                return;
            }
            
            // æ£€æŸ¥è§†é¢‘æ ¼å¼
            const supportedFormats = ['mp4', 'webm', 'ogg', 'avi', 'mov', 'mkv'];
            const fileExtension = file.name.split('.').pop().toLowerCase();
            if (!supportedFormats.includes(fileExtension)) {
                showError(`ä¸æ”¯æŒçš„è§†é¢‘æ ¼å¼ã€‚æ”¯æŒçš„æ ¼å¼: ${supportedFormats.join(', ')}`);
                return;
            }

            selectedFile = file;
            const fileSizeMB = (file.size / (1024 * 1024)).toFixed(2);
            document.getElementById('fileName').innerHTML = `
                <div style="color: #28a745; font-weight: bold;">âœ… å·²é€‰æ‹©: ${file.name}</div>
                <div style="color: #6c757d; font-size: 0.9rem; margin-top: 5px;">
                    å¤§å°: ${fileSizeMB}MB | æ ¼å¼: ${fileExtension.toUpperCase()}
                </div>
            `;
            document.getElementById('processBtn').disabled = false;
            
            // é¢„ä¼°å¤„ç†æ—¶é—´
            estimateProcessingTime(file);
        }
        
        // é¢„ä¼°å¤„ç†æ—¶é—´
        async function estimateProcessingTime(file) {
            try {
                const video = document.createElement('video');
                video.src = URL.createObjectURL(file);
                
                video.addEventListener('loadedmetadata', () => {
                    const duration = video.duration;
                    const estimatedTime = Math.ceil(duration * 0.3); // å‡è®¾å¤„ç†æ—¶é—´æ˜¯è§†é¢‘æ—¶é•¿çš„30%
                    
                    const timeText = estimatedTime > 60 ? 
                        `çº¦${Math.ceil(estimatedTime / 60)}åˆ†é’Ÿ` : 
                        `çº¦${estimatedTime}ç§’`;
                    
                    document.getElementById('fileName').innerHTML += `
                        <div style="color: #17a2b8; font-size: 0.9rem; margin-top: 5px;">
                            è§†é¢‘æ—¶é•¿: ${formatTime(duration)} | é¢„è®¡å¤„ç†æ—¶é—´: ${timeText}
                        </div>
                    `;
                    
                    video.remove();
                });
            } catch (error) {
                console.warn('æ— æ³•è·å–è§†é¢‘ä¿¡æ¯:', error);
            }
        }

        // å¤„ç†è§†é¢‘ - æ·»åŠ æ›´è¯¦ç»†çš„è¿›åº¦è·Ÿè¸ªå’Œé”™è¯¯å¤„ç†
        async function processVideo() {
            if (!selectedFile) {
                showError('è¯·å…ˆé€‰æ‹©è§†é¢‘æ–‡ä»¶');
                return;
            }
            
            // æ£€æŸ¥æœ€å¤§å¤„ç†æ—¶é•¿
            const maxDuration = parseInt(document.getElementById('maxDuration').value) || 500;
            
            // ç¦ç”¨å¤„ç†æŒ‰é’®
            const processBtn = document.getElementById('processBtn');
            processBtn.disabled = true;
            processBtn.textContent = 'â³ å¤„ç†ä¸­...';

            showProgress();
            updateProgress(0, 'æ­£åœ¨åˆå§‹åŒ–å¤„ç†æµç¨‹...');
            
            const startTime = Date.now();

            try {
                // æ£€æŸ¥è§†é¢‘æ—¶é•¿
                const videoDuration = await getVideoDuration(selectedFile);
                if (videoDuration > maxDuration) {
                    throw new Error(`è§†é¢‘æ—¶é•¿(${Math.ceil(videoDuration)}ç§’)è¶…è¿‡æœ€å¤§å¤„ç†æ—¶é•¿(${maxDuration}ç§’)`);
                }
                
                updateProgress(5, 'è§†é¢‘éªŒè¯å®Œæˆï¼Œæ­£åœ¨æå–éŸ³é¢‘...');

                // æå–éŸ³é¢‘
                const audioBlob = await extractAudio(selectedFile);
                updateProgress(25, 'éŸ³é¢‘æå–å®Œæˆï¼Œæ­£åœ¨è¿›è¡Œè¯­éŸ³è¯†åˆ«...');

                // ä½¿ç”¨Whisperè¿›è¡Œè¯­éŸ³è¯†åˆ«
                const transcriptionResult = await transcribeAudio(audioBlob);
                
                if (!transcriptionResult || transcriptionResult.length === 0) {
                    throw new Error('è¯­éŸ³è¯†åˆ«æœªæ£€æµ‹åˆ°ä»»ä½•å†…å®¹ï¼Œè¯·æ£€æŸ¥éŸ³é¢‘è´¨é‡');
                }
                
                updateProgress(50, `è¯†åˆ«å®Œæˆï¼Œæ£€æµ‹åˆ°${transcriptionResult.length}ä¸ªè¯­éŸ³ç‰‡æ®µï¼Œæ­£åœ¨ç”Ÿæˆå­—å¹•...`);

                // ç›´æ¥ä½¿ç”¨è½¬å½•ç»“æœç”Ÿæˆå­—å¹•
                subtitles = transcriptionResult.map((segment, index) => ({
                    id: index + 1,
                    start: segment.start,
                    end: segment.end,
                    text: segment.text
                }));
                updateProgress(95, 'å­—å¹•ç”Ÿæˆå®Œæˆ...');
                
                const processingTime = Math.ceil((Date.now() - startTime) / 1000);
                updateProgress(100, `å­—å¹•ç”Ÿæˆå®Œæˆï¼å¤„ç†è€—æ—¶: ${processingTime}ç§’`);

                setTimeout(() => {
                    showResult();
                    showSuccess(`æˆåŠŸç”Ÿæˆ${subtitles.length}æ¡å­—å¹•ï¼`);
                }, 1000);
                
            } catch (error) {
                console.error('å¤„ç†å¤±è´¥:', error);
                showError('å¤„ç†å¤±è´¥: ' + error.message);
                hideProgress();
            } finally {
                // æ¢å¤å¤„ç†æŒ‰é’®
                processBtn.disabled = false;
                processBtn.textContent = 'ğŸš€ å¼€å§‹ç”Ÿæˆå­—å¹•';
            }
        }
        
        // è·å–è§†é¢‘æ—¶é•¿
        function getVideoDuration(file) {
            return new Promise((resolve, reject) => {
                const video = document.createElement('video');
                video.src = URL.createObjectURL(file);
                
                video.addEventListener('loadedmetadata', () => {
                    resolve(video.duration);
                    video.remove();
                });
                
                video.addEventListener('error', () => {
                    reject(new Error('æ— æ³•è¯»å–è§†é¢‘ä¿¡æ¯'));
                });
            });
        }

        // æå–éŸ³é¢‘ - æ”¹è¿›ç‰ˆæœ¬ï¼Œä½¿ç”¨Web Audio API
        async function extractAudio(videoFile) {
            return new Promise((resolve, reject) => {
                const video = document.createElement('video');
                video.src = URL.createObjectURL(videoFile);
                video.muted = true; // é¿å…æ’­æ”¾å£°éŸ³
                
                video.addEventListener('loadedmetadata', async () => {
                    try {
                        // åˆ›å»ºéŸ³é¢‘ä¸Šä¸‹æ–‡
                        audioContext = new (window.AudioContext || window.webkitAudioContext)();
                        
                        // åˆ›å»ºç¦»çº¿éŸ³é¢‘ä¸Šä¸‹æ–‡è¿›è¡Œå¤„ç†
                        const offlineContext = new OfflineAudioContext(
                            1, // å•å£°é“
                            audioContext.sampleRate * video.duration,
                            audioContext.sampleRate
                        );
                        
                        // åˆ›å»ºéŸ³é¢‘æº
                        const source = audioContext.createMediaElementSource(video);
                        const destination = audioContext.createMediaStreamDestination();
                        source.connect(destination);
                        
                        // å½•åˆ¶éŸ³é¢‘
                        const mediaRecorder = new MediaRecorder(destination.stream, {
                            mimeType: 'audio/webm;codecs=opus'
                        });
                        const chunks = [];
                        
                        mediaRecorder.ondataavailable = (e) => {
                            if (e.data.size > 0) {
                                chunks.push(e.data);
                            }
                        };
                        
                        mediaRecorder.onstop = () => {
                            const audioBlob = new Blob(chunks, { type: 'audio/webm' });
                            resolve(audioBlob);
                        };
                        
                        mediaRecorder.start(1000); // æ¯ç§’è®°å½•ä¸€æ¬¡
                        video.play();
                        
                        video.addEventListener('ended', () => {
                            mediaRecorder.stop();
                            video.remove();
                        });
                        
                    } catch (error) {
                        reject(error);
                    }
                });
                
                video.addEventListener('error', () => {
                    reject(new Error('è§†é¢‘åŠ è½½å¤±è´¥'));
                });
            });
        }

        // è¯­éŸ³è½¬å½• - ä½¿ç”¨Whisper APIæˆ–æœ¬åœ°WhisperæœåŠ¡
        async function transcribeAudio(audioBlob) {
            const whisperUrl = document.getElementById('whisperUrl')?.value || 'http://localhost:9000';
            const sourceLanguage = document.getElementById('sourceLanguage').value;
            
            try {
                // é¦–å…ˆå°è¯•ä½¿ç”¨æœ¬åœ°WhisperæœåŠ¡
                const formData = new FormData();
                formData.append('audio', audioBlob, 'audio.webm');
                formData.append('language', sourceLanguage === 'auto' ? '' : sourceLanguage);
                formData.append('task', 'transcribe');
                formData.append('response_format', 'verbose_json');
                
                const response = await fetch(`${whisperUrl}/v1/audio/transcriptions`, {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    const data = await response.json();
                    return data.segments.map(segment => ({
                        start: segment.start,
                        end: segment.end,
                        text: segment.text.trim()
                    }));
                }
            } catch (error) {
                console.warn('æœ¬åœ°WhisperæœåŠ¡ä¸å¯ç”¨ï¼Œå°è¯•å…¶ä»–æ–¹æ³•:', error);
            }
            
            // Fallback: ä½¿ç”¨æµè§ˆå™¨çš„Web Speech API
            return new Promise((resolve, reject) => {
                if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                    // æœ€åçš„fallback: ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
                    const mockTranscription = [
                        { start: 0, end: 3, text: "è¿™æ˜¯ä¸€ä¸ªç¤ºä¾‹è½¬å½•æ–‡æœ¬ã€‚" },
                        { start: 3, end: 6, text: "å®é™…ä½¿ç”¨æ—¶ä¼šè°ƒç”¨Whisper APIè¿›è¡Œè¯­éŸ³è¯†åˆ«ã€‚" },
                        { start: 6, end: 9, text: "è¯·ç¡®ä¿WhisperæœåŠ¡æ­£åœ¨è¿è¡Œã€‚" }
                    ];
                    resolve(mockTranscription);
                    return;
                }

                try {
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    const recognition = new SpeechRecognition();
                    
                    recognition.continuous = true;
                    recognition.interimResults = false;
                    recognition.lang = sourceLanguage === 'auto' ? 'zh-CN' : 
                                     getLanguageCode(sourceLanguage);

                    const results = [];
                    let currentTime = 0;

                    recognition.onresult = (event) => {
                        for (let i = 0; i < event.results.length; i++) {
                            if (event.results[i].isFinal) {
                                const text = event.results[i][0].transcript;
                                const duration = Math.max(2, text.length * 0.1); // æ ¹æ®æ–‡æœ¬é•¿åº¦ä¼°ç®—æ—¶é•¿
                                results.push({
                                    start: currentTime,
                                    end: currentTime + duration,
                                    text: text.trim()
                                });
                                currentTime += duration;
                            }
                        }
                    };

                    recognition.onend = () => {
                        resolve(results);
                    };

                    recognition.onerror = (event) => {
                        reject(new Error('è¯­éŸ³è¯†åˆ«å¤±è´¥: ' + event.error));
                    };

                    // æ’­æ”¾éŸ³é¢‘è¿›è¡Œè¯†åˆ«
                    const audio = new Audio(URL.createObjectURL(audioBlob));
                    audio.muted = true;
                    audio.play();
                    recognition.start();

                } catch (error) {
                    reject(error);
                }
            });
        }
        
        // è·å–è¯­è¨€ä»£ç 
        function getLanguageCode(lang) {
            const langMap = {
                'zh': 'zh-CN',
                'en': 'en-US',
                'ja': 'ja-JP',
                'ko': 'ko-KR',
                'fr': 'fr-FR',
                'es': 'es-ES',
                'de': 'de-DE'
            };
            return langMap[lang] || 'zh-CN';
        }

        // è¿™é‡Œå·²ç§»é™¤Ollamaç›¸å…³å‡½æ•°

        // æ˜¾ç¤ºè¿›åº¦
        function showProgress() {
            document.getElementById('progressSection').style.display = 'block';
            document.getElementById('resultSection').style.display = 'none';
        }

        // æ›´æ–°è¿›åº¦
        function updateProgress(percent, text) {
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('progressText').textContent = text;
        }

        // éšè—è¿›åº¦
        function hideProgress() {
            document.getElementById('progressSection').style.display = 'none';
        }

        // æ˜¾ç¤ºç»“æœ
        function showResult() {
            hideProgress();
            
            // æ˜¾ç¤ºè§†é¢‘é¢„è§ˆ
            const videoPreview = document.getElementById('videoPreview');
            videoPreview.src = URL.createObjectURL(selectedFile);
            
            // æ˜¾ç¤ºå­—å¹•ç¼–è¾‘å™¨
            renderSubtitleEditor();
            
            document.getElementById('resultSection').style.display = 'block';
        }

        // æ¸²æŸ“å­—å¹•ç¼–è¾‘å™¨
        function renderSubtitleEditor() {
            const subtitleList = document.getElementById('subtitleList');
            subtitleList.innerHTML = '';
            
            subtitles.forEach((subtitle, index) => {
                const subtitleItem = document.createElement('div');
                subtitleItem.className = 'subtitle-item';
                subtitleItem.innerHTML = `
                    <div class="subtitle-time">${formatTime(subtitle.start)} --> ${formatTime(subtitle.end)}</div>
                    <textarea class="subtitle-text" onchange="updateSubtitle(${index}, this.value)">${subtitle.text}</textarea>
                `;
                subtitleList.appendChild(subtitleItem);
            });
        }

        // æ›´æ–°å­—å¹•
        function updateSubtitle(index, newText) {
            subtitles[index].text = newText;
        }

        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);
            const ms = Math.floor((seconds % 1) * 1000);
            
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')},${ms.toString().padStart(3, '0')}`;
        }

        // ä¸‹è½½SRTæ–‡ä»¶
        function downloadSRT() {
            let srtContent = '';
            subtitles.forEach((subtitle, index) => {
                srtContent += `${index + 1}\n`;
                srtContent += `${formatTime(subtitle.start)} --> ${formatTime(subtitle.end)}\n`;
                srtContent += `${subtitle.text}\n\n`;
            });
            
            downloadFile(srtContent, 'subtitles.srt', 'text/plain');
        }

        // ä¸‹è½½VTTæ–‡ä»¶
        function downloadVTT() {
            let vttContent = 'WEBVTT\n\n';
            subtitles.forEach((subtitle) => {
                vttContent += `${formatTime(subtitle.start)} --> ${formatTime(subtitle.end)}\n`;
                vttContent += `${subtitle.text}\n\n`;
            });
            
            downloadFile(vttContent, 'subtitles.vtt', 'text/vtt');
        }

        // ä¸‹è½½JSONæ–‡ä»¶
        function downloadJSON() {
            const jsonContent = JSON.stringify(subtitles, null, 2);
            downloadFile(jsonContent, 'subtitles.json', 'application/json');
        }

        // ä¸‹è½½æ–‡ä»¶è¾…åŠ©å‡½æ•°
        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = message;
            
            const mainContent = document.querySelector('.main-content');
            mainContent.appendChild(errorDiv);
            
            setTimeout(() => {
                errorDiv.remove();
            }, 5000);
        }

        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
        function showSuccess(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'success-message';
            successDiv.textContent = message;
            
            const mainContent = document.querySelector('.main-content');
            mainContent.appendChild(successDiv);
            
            setTimeout(() => {
                successDiv.remove();
            }, 5000);
        }
    </script>
</body>
</html>