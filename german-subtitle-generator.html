<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>字幕生成器</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .main-content {
            padding: 40px;
        }

        .upload-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            border: 2px dashed #dee2e6;
            text-align: center;
            transition: all 0.3s ease;
        }

        .upload-section:hover {
            border-color: #4facfe;
            background: #f0f8ff;
        }

        .upload-section.dragover {
            border-color: #00f2fe;
            background: #e6f3ff;
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 4rem;
            color: #6c757d;
            margin-bottom: 20px;
        }

        .upload-text {
            font-size: 1.2rem;
            color: #495057;
            margin-bottom: 20px;
        }

        .file-input {
            display: none;
        }

        .upload-btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(79, 172, 254, 0.4);
        }

        .upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(79, 172, 254, 0.6);
        }

        .settings-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .setting-group {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
        }

        .setting-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #495057;
        }

        .setting-group select,
        .setting-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .setting-group select:focus,
        .setting-group input:focus {
            outline: none;
            border-color: #4facfe;
        }

        .process-btn {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 25px;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(17, 153, 142, 0.4);
            width: 100%;
            margin-top: 20px;
        }

        .process-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(17, 153, 142, 0.6);
        }

        .process-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .progress-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 10px;
        }

        .progress-text {
            text-align: center;
            font-weight: 600;
            color: #495057;
        }

        .result-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            display: none;
        }

        .video-preview {
            width: 100%;
            max-width: 600px;
            margin: 0 auto 30px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .subtitle-editor {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .subtitle-item {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #4facfe;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .subtitle-time {
            font-size: 0.9rem;
            color: #6c757d;
            margin-bottom: 5px;
        }

        .subtitle-text {
            width: 100%;
            border: none;
            background: transparent;
            font-size: 1rem;
            resize: vertical;
            min-height: 40px;
        }

        .subtitle-text:focus {
            outline: none;
        }

        .download-section {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        .download-btn {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 20px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .download-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(250, 112, 154, 0.4);
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            border: 1px solid #f5c6cb;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            border: 1px solid #c3e6cb;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .main-content {
                padding: 20px;
            }
            
            .settings-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎬 字幕生成器</h1>
            <p>基于Whisper的智能字幕生成工具</p>
            <div style="margin-top: 15px; font-size: 0.9rem; opacity: 0.8;">
                支持多种视频格式 | 本地化处理 | 可编辑字幕
            </div>
        </div>

        <div class="main-content">
            <!-- 文件上传区域 -->
            <div class="upload-section" id="uploadSection">
                <div class="upload-icon">📁</div>
                <div class="upload-text">拖拽视频文件到此处或点击选择文件</div>
                <div style="font-size: 0.9rem; color: #6c757d; margin-top: 10px;">
                    支持格式: MP4, WebM, AVI, MOV, MKV | 最大500MB
                </div>
                <input type="file" id="fileInput" class="file-input" accept="video/*">
                <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                    选择视频文件
                </button>
                <div id="fileName" style="margin-top: 15px; font-weight: 600; color: #495057;"></div>
            </div>

            <!-- 设置区域 -->
            <div class="settings-section">
                <h3 style="margin-bottom: 20px; color: #495057;">⚙️ 生成设置</h3>
                <div class="settings-grid">
                    <div class="setting-group">
                        <label for="sourceLanguage">源语言</label>
                        <select id="sourceLanguage">
                            <option value="auto">自动检测</option>
                            <option value="zh">中文</option>
                            <option value="en">英语</option>
                            <option value="ja">日语</option>
                            <option value="ko">韩语</option>
                            <option value="fr">法语</option>
                            <option value="es">西班牙语</option>
                        </select>
                    </div>

                    <div class="setting-group">
                        <label for="whisperUrl">Whisper服务地址</label>
                        <input type="text" id="whisperUrl" value="http://localhost:9000" placeholder="http://localhost:9000">
                    </div>
                    <div class="setting-group">
                        <label for="maxDuration">最大处理时长(秒)</label>
                        <input type="number" id="maxDuration" value="300" min="30" max="3600" placeholder="500">
                    </div>
                </div>
                <button class="process-btn" id="processBtn" onclick="processVideo()" disabled>
                    🚀 开始生成字幕
                </button>
                <div style="margin-top: 15px; padding: 15px; background: #e3f2fd; border-radius: 8px; font-size: 0.9rem; color: #1565c0;">
                    <strong>💡 使用提示：</strong><br>
                    1. 确保Whisper服务运行在 http://localhost:9000<br>
                    2. 建议使用清晰音质的视频文件以获得更好效果
                </div>
            </div>

            <!-- 进度区域 -->
            <div class="progress-section" id="progressSection">
                <h3 style="margin-bottom: 20px; color: #495057;">🔄 处理进度</h3>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-text" id="progressText">准备中...</div>
            </div>

            <!-- 结果区域 -->
            <div class="result-section" id="resultSection">
                <h3 style="margin-bottom: 20px; color: #495057;">✅ 生成结果</h3>
                <div class="video-preview">
                    <video id="videoPreview" controls style="width: 100%;"></video>
                </div>
                
                <div class="subtitle-editor" id="subtitleEditor">
                    <h4 style="margin-bottom: 15px; color: #495057;">字幕编辑器</h4>
                    <div id="subtitleList"></div>
                </div>

                <div class="download-section">
                    <button class="download-btn" onclick="downloadSRT()">
                        📄 下载SRT文件
                    </button>
                    <button class="download-btn" onclick="downloadVTT()">
                        📝 下载VTT文件
                    </button>
                    <button class="download-btn" onclick="downloadJSON()">
                        🔧 下载JSON文件
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let selectedFile = null;
        let subtitles = [];
        let audioContext = null;

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            setupDragAndDrop();
            setupFileInput();
        });

        // 设置拖拽上传
        function setupDragAndDrop() {
            const uploadSection = document.getElementById('uploadSection');
            
            uploadSection.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadSection.classList.add('dragover');
            });

            uploadSection.addEventListener('dragleave', function(e) {
                e.preventDefault();
                uploadSection.classList.remove('dragover');
            });

            uploadSection.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadSection.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileSelect(files[0]);
                }
            });
        }

        // 设置文件输入
        function setupFileInput() {
            const fileInput = document.getElementById('fileInput');
            fileInput.addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    handleFileSelect(e.target.files[0]);
                }
            });
        }

        // 处理文件选择 - 添加文件验证和大小检查
        function handleFileSelect(file) {
            if (!file.type.startsWith('video/')) {
                showError('请选择有效的视频文件');
                return;
            }
            
            // 检查文件大小 (限制为500MB)
            const maxSize = 500 * 1024 * 1024; // 500MB
            if (file.size > maxSize) {
                showError('文件过大，请选择小于500MB的视频文件');
                return;
            }
            
            // 检查视频格式
            const supportedFormats = ['mp4', 'webm', 'ogg', 'avi', 'mov', 'mkv'];
            const fileExtension = file.name.split('.').pop().toLowerCase();
            if (!supportedFormats.includes(fileExtension)) {
                showError(`不支持的视频格式。支持的格式: ${supportedFormats.join(', ')}`);
                return;
            }

            selectedFile = file;
            const fileSizeMB = (file.size / (1024 * 1024)).toFixed(2);
            document.getElementById('fileName').innerHTML = `
                <div style="color: #28a745; font-weight: bold;">✅ 已选择: ${file.name}</div>
                <div style="color: #6c757d; font-size: 0.9rem; margin-top: 5px;">
                    大小: ${fileSizeMB}MB | 格式: ${fileExtension.toUpperCase()}
                </div>
            `;
            document.getElementById('processBtn').disabled = false;
            
            // 预估处理时间
            estimateProcessingTime(file);
        }
        
        // 预估处理时间
        async function estimateProcessingTime(file) {
            try {
                const video = document.createElement('video');
                video.src = URL.createObjectURL(file);
                
                video.addEventListener('loadedmetadata', () => {
                    const duration = video.duration;
                    const estimatedTime = Math.ceil(duration * 0.3); // 假设处理时间是视频时长的30%
                    
                    const timeText = estimatedTime > 60 ? 
                        `约${Math.ceil(estimatedTime / 60)}分钟` : 
                        `约${estimatedTime}秒`;
                    
                    document.getElementById('fileName').innerHTML += `
                        <div style="color: #17a2b8; font-size: 0.9rem; margin-top: 5px;">
                            视频时长: ${formatTime(duration)} | 预计处理时间: ${timeText}
                        </div>
                    `;
                    
                    video.remove();
                });
            } catch (error) {
                console.warn('无法获取视频信息:', error);
            }
        }

        // 处理视频 - 添加更详细的进度跟踪和错误处理
        async function processVideo() {
            if (!selectedFile) {
                showError('请先选择视频文件');
                return;
            }
            
            // 检查最大处理时长
            const maxDuration = parseInt(document.getElementById('maxDuration').value) || 500;
            
            // 禁用处理按钮
            const processBtn = document.getElementById('processBtn');
            processBtn.disabled = true;
            processBtn.textContent = '⏳ 处理中...';

            showProgress();
            updateProgress(0, '正在初始化处理流程...');
            
            const startTime = Date.now();

            try {
                // 检查视频时长
                const videoDuration = await getVideoDuration(selectedFile);
                if (videoDuration > maxDuration) {
                    throw new Error(`视频时长(${Math.ceil(videoDuration)}秒)超过最大处理时长(${maxDuration}秒)`);
                }
                
                updateProgress(5, '视频验证完成，正在提取音频...');

                // 提取音频
                const audioBlob = await extractAudio(selectedFile);
                updateProgress(25, '音频提取完成，正在进行语音识别...');

                // 使用Whisper进行语音识别
                const transcriptionResult = await transcribeAudio(audioBlob);
                
                if (!transcriptionResult || transcriptionResult.length === 0) {
                    throw new Error('语音识别未检测到任何内容，请检查音频质量');
                }
                
                updateProgress(50, `识别完成，检测到${transcriptionResult.length}个语音片段，正在生成字幕...`);

                // 直接使用转录结果生成字幕
                subtitles = transcriptionResult.map((segment, index) => ({
                    id: index + 1,
                    start: segment.start,
                    end: segment.end,
                    text: segment.text
                }));
                updateProgress(95, '字幕生成完成...');
                
                const processingTime = Math.ceil((Date.now() - startTime) / 1000);
                updateProgress(100, `字幕生成完成！处理耗时: ${processingTime}秒`);

                setTimeout(() => {
                    showResult();
                    showSuccess(`成功生成${subtitles.length}条字幕！`);
                }, 1000);
                
            } catch (error) {
                console.error('处理失败:', error);
                showError('处理失败: ' + error.message);
                hideProgress();
            } finally {
                // 恢复处理按钮
                processBtn.disabled = false;
                processBtn.textContent = '🚀 开始生成字幕';
            }
        }
        
        // 获取视频时长
        function getVideoDuration(file) {
            return new Promise((resolve, reject) => {
                const video = document.createElement('video');
                video.src = URL.createObjectURL(file);
                
                video.addEventListener('loadedmetadata', () => {
                    resolve(video.duration);
                    video.remove();
                });
                
                video.addEventListener('error', () => {
                    reject(new Error('无法读取视频信息'));
                });
            });
        }

        // 提取音频 - 改进版本，使用Web Audio API
        async function extractAudio(videoFile) {
            return new Promise((resolve, reject) => {
                const video = document.createElement('video');
                video.src = URL.createObjectURL(videoFile);
                video.muted = true; // 避免播放声音
                
                video.addEventListener('loadedmetadata', async () => {
                    try {
                        // 创建音频上下文
                        audioContext = new (window.AudioContext || window.webkitAudioContext)();
                        
                        // 创建离线音频上下文进行处理
                        const offlineContext = new OfflineAudioContext(
                            1, // 单声道
                            audioContext.sampleRate * video.duration,
                            audioContext.sampleRate
                        );
                        
                        // 创建音频源
                        const source = audioContext.createMediaElementSource(video);
                        const destination = audioContext.createMediaStreamDestination();
                        source.connect(destination);
                        
                        // 录制音频
                        const mediaRecorder = new MediaRecorder(destination.stream, {
                            mimeType: 'audio/webm;codecs=opus'
                        });
                        const chunks = [];
                        
                        mediaRecorder.ondataavailable = (e) => {
                            if (e.data.size > 0) {
                                chunks.push(e.data);
                            }
                        };
                        
                        mediaRecorder.onstop = () => {
                            const audioBlob = new Blob(chunks, { type: 'audio/webm' });
                            resolve(audioBlob);
                        };
                        
                        mediaRecorder.start(1000); // 每秒记录一次
                        video.play();
                        
                        video.addEventListener('ended', () => {
                            mediaRecorder.stop();
                            video.remove();
                        });
                        
                    } catch (error) {
                        reject(error);
                    }
                });
                
                video.addEventListener('error', () => {
                    reject(new Error('视频加载失败'));
                });
            });
        }

        // 语音转录 - 使用Whisper API或本地Whisper服务
        async function transcribeAudio(audioBlob) {
            const whisperUrl = document.getElementById('whisperUrl')?.value || 'http://localhost:9000';
            const sourceLanguage = document.getElementById('sourceLanguage').value;
            
            try {
                // 首先尝试使用本地Whisper服务
                const formData = new FormData();
                formData.append('audio', audioBlob, 'audio.webm');
                formData.append('language', sourceLanguage === 'auto' ? '' : sourceLanguage);
                formData.append('task', 'transcribe');
                formData.append('response_format', 'verbose_json');
                
                const response = await fetch(`${whisperUrl}/v1/audio/transcriptions`, {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    const data = await response.json();
                    return data.segments.map(segment => ({
                        start: segment.start,
                        end: segment.end,
                        text: segment.text.trim()
                    }));
                }
            } catch (error) {
                console.warn('本地Whisper服务不可用，尝试其他方法:', error);
            }
            
            // Fallback: 使用浏览器的Web Speech API
            return new Promise((resolve, reject) => {
                if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                    // 最后的fallback: 使用模拟数据
                    const mockTranscription = [
                        { start: 0, end: 3, text: "这是一个示例转录文本。" },
                        { start: 3, end: 6, text: "实际使用时会调用Whisper API进行语音识别。" },
                        { start: 6, end: 9, text: "请确保Whisper服务正在运行。" }
                    ];
                    resolve(mockTranscription);
                    return;
                }

                try {
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    const recognition = new SpeechRecognition();
                    
                    recognition.continuous = true;
                    recognition.interimResults = false;
                    recognition.lang = sourceLanguage === 'auto' ? 'zh-CN' : 
                                     getLanguageCode(sourceLanguage);

                    const results = [];
                    let currentTime = 0;

                    recognition.onresult = (event) => {
                        for (let i = 0; i < event.results.length; i++) {
                            if (event.results[i].isFinal) {
                                const text = event.results[i][0].transcript;
                                const duration = Math.max(2, text.length * 0.1); // 根据文本长度估算时长
                                results.push({
                                    start: currentTime,
                                    end: currentTime + duration,
                                    text: text.trim()
                                });
                                currentTime += duration;
                            }
                        }
                    };

                    recognition.onend = () => {
                        resolve(results);
                    };

                    recognition.onerror = (event) => {
                        reject(new Error('语音识别失败: ' + event.error));
                    };

                    // 播放音频进行识别
                    const audio = new Audio(URL.createObjectURL(audioBlob));
                    audio.muted = true;
                    audio.play();
                    recognition.start();

                } catch (error) {
                    reject(error);
                }
            });
        }
        
        // 获取语言代码
        function getLanguageCode(lang) {
            const langMap = {
                'zh': 'zh-CN',
                'en': 'en-US',
                'ja': 'ja-JP',
                'ko': 'ko-KR',
                'fr': 'fr-FR',
                'es': 'es-ES',
                'de': 'de-DE'
            };
            return langMap[lang] || 'zh-CN';
        }

        // 这里已移除Ollama相关函数

        // 显示进度
        function showProgress() {
            document.getElementById('progressSection').style.display = 'block';
            document.getElementById('resultSection').style.display = 'none';
        }

        // 更新进度
        function updateProgress(percent, text) {
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('progressText').textContent = text;
        }

        // 隐藏进度
        function hideProgress() {
            document.getElementById('progressSection').style.display = 'none';
        }

        // 显示结果
        function showResult() {
            hideProgress();
            
            // 显示视频预览
            const videoPreview = document.getElementById('videoPreview');
            videoPreview.src = URL.createObjectURL(selectedFile);
            
            // 显示字幕编辑器
            renderSubtitleEditor();
            
            document.getElementById('resultSection').style.display = 'block';
        }

        // 渲染字幕编辑器
        function renderSubtitleEditor() {
            const subtitleList = document.getElementById('subtitleList');
            subtitleList.innerHTML = '';
            
            subtitles.forEach((subtitle, index) => {
                const subtitleItem = document.createElement('div');
                subtitleItem.className = 'subtitle-item';
                subtitleItem.innerHTML = `
                    <div class="subtitle-time">${formatTime(subtitle.start)} --> ${formatTime(subtitle.end)}</div>
                    <textarea class="subtitle-text" onchange="updateSubtitle(${index}, this.value)">${subtitle.text}</textarea>
                `;
                subtitleList.appendChild(subtitleItem);
            });
        }

        // 更新字幕
        function updateSubtitle(index, newText) {
            subtitles[index].text = newText;
        }

        // 格式化时间
        function formatTime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);
            const ms = Math.floor((seconds % 1) * 1000);
            
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')},${ms.toString().padStart(3, '0')}`;
        }

        // 下载SRT文件
        function downloadSRT() {
            let srtContent = '';
            subtitles.forEach((subtitle, index) => {
                srtContent += `${index + 1}\n`;
                srtContent += `${formatTime(subtitle.start)} --> ${formatTime(subtitle.end)}\n`;
                srtContent += `${subtitle.text}\n\n`;
            });
            
            downloadFile(srtContent, 'subtitles.srt', 'text/plain');
        }

        // 下载VTT文件
        function downloadVTT() {
            let vttContent = 'WEBVTT\n\n';
            subtitles.forEach((subtitle) => {
                vttContent += `${formatTime(subtitle.start)} --> ${formatTime(subtitle.end)}\n`;
                vttContent += `${subtitle.text}\n\n`;
            });
            
            downloadFile(vttContent, 'subtitles.vtt', 'text/vtt');
        }

        // 下载JSON文件
        function downloadJSON() {
            const jsonContent = JSON.stringify(subtitles, null, 2);
            downloadFile(jsonContent, 'subtitles.json', 'application/json');
        }

        // 下载文件辅助函数
        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // 显示错误消息
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = message;
            
            const mainContent = document.querySelector('.main-content');
            mainContent.appendChild(errorDiv);
            
            setTimeout(() => {
                errorDiv.remove();
            }, 5000);
        }

        // 显示成功消息
        function showSuccess(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'success-message';
            successDiv.textContent = message;
            
            const mainContent = document.querySelector('.main-content');
            mainContent.appendChild(successDiv);
            
            setTimeout(() => {
                successDiv.remove();
            }, 5000);
        }
    </script>
</body>
</html>